<!DOCTYPE html>
<html lang="en">
<head>
	<title>Backbone Camera View</title>
    <style>
        .bcv-camera {
            border: 1px solid gray;
            height: 500px;
            overflow: hidden;
            position: relative;
            width: 500px;
        }
        .bcv-camera > :first-child {
            position: absolute;
            
            background-color: lightgray;
            top: -50px;
            left: -50px;
            transition: transform 0.5s;
        }
    </style>
</head>
<body>
    <h1>Backbone Camera View</h1>
    
    <div id="camera" class="bcv-camera"></div>
    
    <script id="cameraTemplate" type="text/template">
        <img src="images/FFL-Spritesheet-White-1827x1215.png" alt="Final Fantasy Legend Sprites" width="1827" height="1215" />
    </script>
    
    <script type="text/javascript" src="src/scripts/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="src/scripts/lodash.min.js"></script>
    <script type="text/javascript" src="src/scripts/backbone-min.js"></script>
    <script>
        'use strict';
        
        /**
        * Event throttling using requestAnimationFrame.
        */
        var throttleEvent = function (handler) {
            var isProcessing = false;

            return function (event) {
                if (!isProcessing) {
                    isProcessing = true;

                    window.requestAnimationFrame(function(timestamp) {
                        handler(event, timestamp);
                        isProcessing = false;
                    });    
                }
            };
        };
        
        /**
        * Height and width resizing functionality used for object composition.
        * @constructs SizableView
        */
        var SizableView = function () {
            var instance = {};
            
            instance.setHeight = function (height) {
                if (_.isNumber(height)) {
                    this.$el.height(height);
                }
                else if (_.isElement(height)) {
                    this.$el.height(height.clientHeight);
                }
                else if (_.isFunction(height)) {
                    this.$el.height(height());
                }
            };
            
            instance.setWidth = function (width) {
                if (_.isNumber(width)) {
                    this.$el.width(width);
                }
                else if (_.isElement(width)) {
                    this.$el.width(width.clientWidth);
                }
                else if (_.isFunction(width)) {
                    this.$el.width(width());
                }
            };
            
            return instance;
        };
        
        var constants = {};
        constants.zoom = {
            IN: 1,
            OUT: 0
        };
        
        /**
        * A CameraView's model.
        * @constructs CameraModel
        */
        var CameraModel = function (options) {
            var instance = Object.create(Object.assign(
                Backbone.Model.prototype, {
                    defaults: {
                        /**
                        * The current zoom value.
                        * @property {Number}
                        */
                        zoom: 1,
                        /**
                        * The maximum number of times content can be zoomed in.
                        * @property {Number}
                        */
                        zoomInCount: 2,
                        /**
                        * The maximum number of times content can be zoomed out.
                        * @property {Number}
                        */
                        zoomOutCount: 2,
                        /**
                        * The multiplier used to zoom content in.
                        * @property {Number}
                        */
                        zoomInMultiplier: 2,
                        /**
                        * The multiplier used to zoom content out.
                        * @property {Number}
                        */
                        zoomOutMultiplier: 0.5,
                        /**
                        * The minimum allowed zoom value.
                        * @property {Number}
                        */
                        zoomMin: null,
                        /**
                        * The maximum allowed zoom value.
                        * @property {Number}
                        */
                        zoomMax: null
                    }
                }
            ));
            
            instance.initialize = function () {
                instance.set('zoomMin', Math.pow(instance.get('zoomOutMultiplier'), instance.get('zoomOutCount')));
                instance.set('zoomMax', Math.pow(instance.get('zoomInMultiplier'), instance.get('zoomInCount')));
            };
            
            Backbone.Model.call(instance, options);
            
            return instance;
        };
        
        /**
        * A camera to pan and zoom content.
        * @constructs CameraView
        */
        var CameraView = function (options) {
            var instance = Object.create(Object.assign(
                Backbone.View.prototype, SizableView()
            ));
            
            Object.assign(instance, options);
            
            instance.initialize = function () {
                instance.listenTo(instance.model, 'change:zoom', instance.zoom);
            };
            
            instance.render = function () {
                instance.el.innerHTML = instance.template();
                instance.content = instance.el.querySelector(':first-child');
                instance.content.setAttribute('draggable', false);
                instance.update();
            };
            
            instance.update = function () {
                instance.setWidth(instance.width);
                instance.setHeight(instance.height);
            };
            
            instance.events = function () {
                return {
                    'mousedown'  : 'onMouseDown',
                    'mouseleave' : 'onMouseLeave',
                    'mousemove'  : 'onMouseMove',
                    'mouseup'    : 'onMouseUp',
                    'wheel'      : _.throttle(instance.onWheel, 400)
                };
            };
            
            instance.stop = function () {
                instance.isActive = false;
            };
            
            instance.onMouseDown = function ($event) {
                // TODO: Remove console.log() when development is complete.
                //console.log(event);
                instance.moveStartX = event.clientX;
                instance.moveStartY = event.clientY;
                instance.contentStartX = instance.content.getBoundingClientRect().left - instance.el.getBoundingClientRect().left;
                instance.contentStartY = instance.content.getBoundingClientRect().top - instance.el.getBoundingClientRect().top;
                
                instance.isActive = true;
                
                //console.log('scrollTop: ', instance.el.scrollTop);
                //console.log('scrollLeft: ', instance.el.scrollLeft);
                //console.log('scrollWidth: ', instance.el.scrollWidth);
                //console.log('scrollHeight: ', instance.el.scrollHeight);
                //console.log('eventX: ', event.clientX);
                //console.log('eventY: ', event.clientY);
                //console.log('elX: ', instance.el.getBoundingClientRect());
                //console.log('elY: ', instance.el.getBoundingClientRect());
                //console.log('mouse startX: ', instance.startX);
                //console.log('mouse startY: ', instance.startY);
                //console.log('content startX: ', instance.content.getBoundingClientRect().left - instance.el.getBoundingClientRect().left);
                //console.log('content startY: ', instance.content.getBoundingClientRect().top - instance.el.getBoundingClientRect().top);
            };
            
            instance.onMouseLeave = function ($event) {
                instance.stop();
            };
            
            instance.onMouseMove = function ($event) {
                // TODO: Refactor. Add drag-ability of content when zoomed in/out.
                if (instance.isActive) {
                    // Handle vertical bounds
                    if (instance.contentStartX + event.clientX - instance.moveStartX < 0) {
                        instance.content.style.left = (instance.contentStartX + event.clientX - instance.moveStartX) + 'px';
                    }
                    if (instance.contentStartX + event.clientX - instance.moveStartX >= 0) {
                        instance.moveStartX = event.clientX;
                        instance.contentStartX = 0;
                        instance.content.style.left = 0 + 'px';
                    }
                    if (instance.contentStartX + event.clientX - instance.moveStartX <= instance.el.clientWidth - instance.content.getBoundingClientRect().width) {
                        instance.moveStartX = event.clientX;
                        instance.contentStartX = instance.el.clientWidth - instance.content.getBoundingClientRect().width;
                        instance.content.style.left = instance.el.clientWidth - instance.content.getBoundingClientRect().width + 'px';
                    }
                    
                    // Handle horizontal bounds
                    if (instance.contentStartY + event.clientY - instance.moveStartY < 0) {
                        instance.content.style.top = (instance.contentStartY + event.clientY - instance.moveStartY) + 'px';
                    }
                    if (instance.contentStartY + event.clientY - instance.moveStartY >= 0) {
                        instance.moveStartY = event.clientY;
                        instance.contentStartY = 0;
                        instance.content.style.top = 0 + 'px';
                    }
                    if (instance.contentStartY + event.clientY - instance.moveStartY <= instance.el.clientHeight - instance.content.getBoundingClientRect().height) {
                        instance.moveStartY = event.clientY;
                        instance.contentStartY = instance.el.clientHeight - instance.content.getBoundingClientRect().height;
                        instance.content.style.top = instance.el.clientHeight - instance.content.getBoundingClientRect().height + 'px';
                    }
                }
            };
            
            instance.onMouseUp = function ($event) {
                instance.stop();
            };
            
            /**
            * Handles the wheel input.
            * @public
            * @param {$event} A jQuery event object.
            */
            instance.onWheel = function ($event) {
                instance.wheelZoom($event.originalEvent);
            };
            
            /**
            * Determines whether to zoom in or out based on the wheel input.
            * @public
            * @param {event} A mouse event object.
            */
            instance.wheelZoom = function (event) {
                if (event.deltaY) {
                    var _zoomDirection = event.deltaY > 0 ? constants.zoom.OUT : constants.zoom.IN;
                    var _zoomMultiplier = _zoomDirection === constants.zoom.IN ? instance.model.get('zoomInMultiplier') : instance.model.get('zoomOutMultiplier');
                    instance.setWheelZoom(_zoomMultiplier);
                }
            };
            
            /**
            * Sets the zoom value.
            * @public
            * @param {number} The multiplier which will be applied to the content to determine the new zoom value.
            */
            instance.setWheelZoom = function (multiplier) {
                var _newZoomValue = instance.model.get('zoom') * multiplier;
                
                if (_newZoomValue <= instance.model.get('zoomMin')) {
                    _newZoomValue = instance.model.get('zoomMin');
                }
                else if (_newZoomValue >= instance.model.get('zoomMax')) {
                    _newZoomValue = instance.model.get('zoomMax');
                }

                if (instance.model.get('zoom') !== _newZoomValue) {
                    instance.model.set('zoom', _newZoomValue);
                }
            };
            
            /**
            * Zooms content in or out.
            * @public
            */
            instance.zoom = function () {
                instance.content.style.transform = 'scale(' + instance.model.get('zoom') + ')';
            };
            
            Backbone.View.call(instance, options);
            
            return instance;
        };
        
 
        // App
        var app = Object.assign({}, Backbone.Events);
        
        app.initialize = function () {
            // Views
            var cameraView = CameraView({
                el: document.getElementById('camera'),
                template: _.template(document.getElementById('cameraTemplate').innerHTML),
                model: CameraModel({
                    zoom: 1,
                    zoomInCount: 2,
                    zoomOutCount: 2,
                    zoomInMultiplier: 2,
                    zoomOutMultiplier: 0.5
                }),
                height: 500,
                width: 1000
            }).render();
        };
        
        app.initialize();
    </script>
    
</body>
</html>