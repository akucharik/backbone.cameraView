<!DOCTYPE html>
<html lang="en">
<head>
	<title>Backbone Camera View</title>
    <style>
        body {
            overflow: hidden;
        }
        
        .bcv-camera {
            border: 1px solid gray;
            height: 500px;
            overflow: hidden;
            position: relative;
            width: 500px;
        }
        .bcv-camera > :first-child {
            position: absolute;
            transform-origin: 0 0;
            
            background-color: lightgray;
            top: 0px;
            left: 0px;
        }
    </style>
</head>
<body>
    <h1>Backbone Camera View</h1>
    
    <div id="camera" class="bcv-camera"></div>
    
    <script id="cameraTemplate" type="text/template">
        <div>
            <img src="images/FFL-Spritesheet-White-1827x1215.png" alt="Final Fantasy Legend Sprites" width="1827" height="1215" />
            <div style="position: absolute; top: 0; left: 0; width: 100px; height: 100px; border: 1px solid green;"></div>
            <div style="position: absolute; top: 0; left: 0; width: 200px; height: 200px; border: 1px solid green;"></div>
        </div>
        <div style="position: absolute; top: 0; left: 0; width: 100px; height: 100px; border: 1px solid blue;"></div>
        <div style="position: absolute; top: 0; left: 0; width: 200px; height: 200px; border: 1px solid red;"></div>
        
        <div style="position: absolute; top: 105px; left: 180px; width: 3px; height: 3px; background-color: red;"></div>
        <div style="position: absolute; top: 249px; left: 615px; width: 3px; height: 3px; background-color: red;"></div>
    </script>
    
    <script type="text/javascript" src="src/scripts/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="src/scripts/lodash.min.js"></script>
    <script type="text/javascript" src="src/scripts/backbone-min.js"></script>
    <script>
        'use strict';
        
        /**
        * Event throttling using requestAnimationFrame.
        */
        var throttleEvent = function (handler) {
            var isProcessing = false;

            return function (event) {
                if (!isProcessing) {
                    isProcessing = true;

                    window.requestAnimationFrame(function(timestamp) {
                        handler(event, timestamp);
                        isProcessing = false;
                    });    
                }
            };
        };
        
        /**
        * Height and width resizing functionality used for object composition.
        * @constructs SizableView
        */
        var SizableView = function () {
            var instance = {};
            
            instance.setHeight = function (height) {
                if (_.isNumber(height)) {
                    this.$el.height(height);
                }
                else if (_.isElement(height)) {
                    this.$el.height(height.clientHeight);
                }
                else if (_.isFunction(height)) {
                    this.$el.height(height());
                }
            };
            
            instance.setWidth = function (width) {
                if (_.isNumber(width)) {
                    this.$el.width(width);
                }
                else if (_.isElement(width)) {
                    this.$el.width(width.clientWidth);
                }
                else if (_.isFunction(width)) {
                    this.$el.width(width());
                }
            };
            
            return instance;
        };
        
        var constants = {};
        constants.zoom = {
            IN: 1,
            OUT: 0
        };
        
        /**
        * A CameraView's model.
        * @constructs CameraModel
        */
        var CameraModel = function (options) {
            var instance = Object.create(Object.assign(
                Backbone.Model.prototype, {
                    defaults: {
                        /**
                        * The current zoom value.
                        * @property {Number}
                        */
                        zoom: 1,
                        /**
                        * The maximum number of times content can be zoomed in.
                        * @property {Number}
                        */
                        zoomInCount: 3,
                        /**
                        * The maximum number of times content can be zoomed out.
                        * @property {Number}
                        */
                        zoomOutCount: 3,
                        /**
                        * The multiplier used to zoom content in.
                        * @property {Number}
                        */
                        zoomInMultiplier: 2,
                        /**
                        * The multiplier used to zoom content out.
                        * @property {Number}
                        */
                        zoomOutMultiplier: 0.5,
                        /**
                        * The minimum allowed zoom value.
                        * @property {Number}
                        */
                        zoomMin: 0.25,
                        /**
                        * The maximum allowed zoom value.
                        * @property {Number}
                        */
                        zoomMax: 4.0,
                        /**
                        * The zoom origin coordinates.
                        * @property {Number}
                        */
                        zoomOrigin: null,
                        initialZoomOrigin: null,
                        zoomIncrement: 0.1
                    }
                }
            ));
            
            instance.initialize = function () {
                //instance.set('zoomMin', Math.pow(instance.get('zoomOutMultiplier'), instance.get('zoomOutCount')));
                //instance.set('zoomMax', Math.pow(instance.get('zoomInMultiplier'), instance.get('zoomInCount')));
            };
            
            Backbone.Model.call(instance, options);
            
            return instance;
        };
        
        /**
        * A camera to pan and zoom content.
        * @constructs CameraView
        */
        var CameraView = function (options) {
            var instance = Object.create(Object.assign(
                Backbone.View.prototype, SizableView()
            ));
            
            Object.assign(instance, options);
            
            instance.initialize = function () {
                instance.listenTo(instance.model, 'change:zoom', instance.zoom);
            };
            
            instance.render = function () {
                instance.el.innerHTML = instance.template();
                instance.content = instance.el.querySelector(':first-child');
                instance.content.setAttribute('draggable', false);
                instance.update();
            };
            
            instance.update = function () {
                instance.setWidth(instance.width);
                instance.setHeight(instance.height);
            };
            
            instance.events = function () {
                return {
                    'click'      : 'onClick',
                    'mousedown'  : 'onMouseDown',
                    'mouseleave' : 'onMouseLeave',
                    'mousemove'  : 'onMouseMove',
                    'mouseup'    : 'onMouseUp',
                    'wheel'      : _.throttle(instance.onWheel, 500)
                    //'wheel'      : _.throttle(instance.onWheel, 400)
                };
            };
            
            instance.onClick = function ($event) {
                //instance.setZoomOrigin($event.originalEvent);
                var event = $event.originalEvent;
                console.log({ 
                    x: event.clientX - instance.content.getBoundingClientRect().left + window.scrollX,
                    y: event.clientY - instance.content.getBoundingClientRect().top + window.scrollX
                });
            };
            
            instance.stop = function () {
                instance.isActive = false;
            };
            
            instance.onMouseDown = function ($event) {
                // TODO: Remove console.log() when development is complete.
                //console.log($event.originalEvent);
                
                //console.log(instance.el.getBoundingClientRect());
                //console.log('top: ', instance.el.getBoundingClientRect().top + window.scrollY);
                instance.moveStartX = event.clientX;
                instance.moveStartY = event.clientY;
                instance.contentStartX = instance.content.getBoundingClientRect().left + window.scrollX - instance.el.getBoundingClientRect().left + window.scrollX;
                instance.contentStartY = instance.content.getBoundingClientRect().top + window.scrollY - instance.el.getBoundingClientRect().top + window.scrollY;
                
                instance.isActive = true;
                
                //console.log('scrollTop: ', instance.el.scrollTop);
                //console.log('scrollLeft: ', instance.el.scrollLeft);
                //console.log('scrollWidth: ', instance.el.scrollWidth);
                //console.log('scrollHeight: ', instance.el.scrollHeight);
                //console.log('eventX: ', event.clientX);
                //console.log('eventY: ', event.clientY);
                //console.log('elX: ', instance.el.getBoundingClientRect());
                //console.log('elY: ', instance.el.getBoundingClientRect());
                //console.log('mouse startX: ', instance.startX);
                //console.log('mouse startY: ', instance.startY);
                //console.log('content startX: ', instance.content.getBoundingClientRect().left - instance.el.getBoundingClientRect().left);
                //console.log('content startY: ', instance.content.getBoundingClientRect().top - instance.el.getBoundingClientRect().top);
            };
            
            instance.onMouseLeave = function ($event) {
                instance.stop();
            };
            
            instance.onMouseMove = function ($event) {
                // TODO: Refactor. Add drag-ability of content when zoomed in/out.
                if (instance.isActive) {
                    console.log('move');
                    // Handle vertical bounds
                    if (instance.contentStartX + event.clientX - instance.moveStartX < 0) {
                        instance.content.style.left = (instance.contentStartX + event.clientX - instance.moveStartX) + 'px';
                    }
                    if (instance.contentStartX + event.clientX - instance.moveStartX >= 0) {
                        instance.moveStartX = event.clientX;
                        instance.contentStartX = 0;
                        instance.content.style.left = 0 + 'px';
                    }
                    if (instance.contentStartX + event.clientX - instance.moveStartX <= instance.el.clientWidth - instance.content.getBoundingClientRect().width) {
                        instance.moveStartX = event.clientX;
                        instance.contentStartX = instance.el.clientWidth - instance.content.getBoundingClientRect().width;
                        instance.content.style.left = instance.el.clientWidth - instance.content.getBoundingClientRect().width + 'px';
                    }
                    
                    // Handle horizontal bounds
                    if (instance.contentStartY + event.clientY - instance.moveStartY < 0) {
                        instance.content.style.top = (instance.contentStartY + event.clientY - instance.moveStartY) + 'px';
                    }
                    if (instance.contentStartY + event.clientY - instance.moveStartY >= 0) {
                        instance.moveStartY = event.clientY;
                        instance.contentStartY = 0;
                        instance.content.style.top = 0 + 'px';
                    }
                    if (instance.contentStartY + event.clientY - instance.moveStartY <= instance.el.clientHeight - instance.content.getBoundingClientRect().height) {
                        instance.moveStartY = event.clientY;
                        instance.contentStartY = instance.el.clientHeight - instance.content.getBoundingClientRect().height;
                        instance.content.style.top = instance.el.clientHeight - instance.content.getBoundingClientRect().height + 'px';
                    }
                }
            };
            
            instance.onMouseUp = function ($event) {
                instance.stop();
            };
            
            /**
            * Handles the wheel input.
            * @public
            * @param {$event} A jQuery event object.
            */
            instance.onWheel = function ($event) {
                instance.wheelZoom($event.originalEvent);
            };
            
            /**
            * Determines whether to zoom in or out based on the wheel input.
            * @public
            * @param {event} A mouse event object.
            */
            instance.wheelZoom = function (event) {
                if (event.deltaY) {
                    var _direction = event.deltaY > 0 ? constants.zoom.OUT : constants.zoom.IN;
                    var _newValue = instance.model.get('zoom') + instance.model.get('zoomIncrement') * (_direction === constants.zoom.IN ? 1 : -1);
                    //var _multiplier = _direction === constants.zoom.IN ? instance.model.get('zoomInMultiplier') : instance.model.get('zoomOutMultiplier');
                    //var _newValue = instance.model.get('zoom') * _multiplier;
                
                    if (_newValue < instance.model.get('zoomMin')) {
                        _newValue = instance.model.get('zoomMin');
                    }
                    else if (_newValue > instance.model.get('zoomMax')) {
                        _newValue = instance.model.get('zoomMax');
                    }

                    if (instance.model.get('zoom') !== _newValue) {
                        console.log('zoom: ', instance.model.get('zoom'));
                        
                        instance.model.set('zoomOrigin', {
                            x: (event.clientX - instance.content.getBoundingClientRect().left + window.scrollX) / instance.model.get('zoom'),
                            y: (event.clientY - instance.content.getBoundingClientRect().top + window.scrollY) / instance.model.get('zoom')
                        });
                        
                        if (!instance.model.get('initialZoomOrigin')) {
                            instance.model.set('initialZoomOrigin', instance.model.get('zoomOrigin'));
                        }
                        
                        //var _prevZoomOrigin = instance.model.previous('zoomOrigin') || instance.model.get('zoomOrigin');
                        var _prevZoomOrigin = instance.model.get('initialZoomOrigin');
                        
                        var _originDiff = {
                            x: instance.model.get('zoomOrigin').x - _prevZoomOrigin.x,
                            y: instance.model.get('zoomOrigin').y - _prevZoomOrigin.y
                        };
                        
                        console.log('prevOrigin: ', _prevZoomOrigin);
                        console.log('origin: ', instance.model.get('zoomOrigin'));
                        console.log('originDiff: ', _originDiff);
                        
                        var _prevZoomOriginScaled = {
                            x: _prevZoomOrigin.x * instance.model.get('zoom'),
                            y: _prevZoomOrigin.y * instance.model.get('zoom')
                        };
                        
                        var _zoomOriginScaled = {
                            x: (event.clientX - instance.content.getBoundingClientRect().left + window.scrollX),
                            y: (event.clientY - instance.content.getBoundingClientRect().top + window.scrollY)
                        }
                        
                        var _zoomOriginScaledDiff = {
                            x: _zoomOriginScaled.x - _prevZoomOriginScaled.x,
                            y: _zoomOriginScaled.y - _prevZoomOriginScaled.y,
                        };
                        
                        console.log('prevOriginScaled: ', _prevZoomOriginScaled);
                        console.log('originScaled: ', _zoomOriginScaled);
                        //console.log('initialOrigin: ', instance.content.getBoundingClientRect().width / 2 / instance.model.get('zoom'), ', ', instance.content.getBoundingClientRect().height / 2 / instance.model.get('zoom'));
                        console.log('originScaledDiff: ', {
                            x: _zoomOriginScaledDiff.x, 
                            y: _zoomOriginScaledDiff.y
                        });
                        
                        var _contentPosition = {
                            x: parseFloat(window.getComputedStyle(instance.content).getPropertyValue('left')),
                            y: parseFloat(window.getComputedStyle(instance.content).getPropertyValue('top'))
                        };
                        
                        if (_direction === constants.zoom.OUT) {
                            var _originXDifference = _prevZoomOrigin.x - instance.model.get('zoomOrigin').x;
                            var _originYDifference = _prevZoomOrigin.y - instance.model.get('zoomOrigin').y;
                        }
                        else {
                            var _originXDifference = instance.model.get('zoomOrigin').x - _prevZoomOrigin.x;
                            var _originYDifference = instance.model.get('zoomOrigin').y - _prevZoomOrigin.y;
                        }
                        
                        //var _originXDifference = instance.model.get('zoomOrigin').x - _prevZoomOrigin.x;
                        //var _originYDifference = instance.model.get('zoomOrigin').y - _prevZoomOrigin.y;
                        
                        //console.log('originDifference: ', _originXDifference, ',', _originYDifference);


                        //console.log('originDifference: ', _originXDifference, ',', _originYDifference);

                        var _contentX = parseFloat(window.getComputedStyle(instance.content).getPropertyValue('left'));
                        var _contentY = parseFloat(window.getComputedStyle(instance.content).getPropertyValue('top'));
                        
                        if (_direction === constants.zoom.OUT) {
                            console.log('zoom out');
                            _contentX = _contentX + _originXDifference * instance.model.get('zoom'); //+ (event.clientX - instance.el.getBoundingClientRect().left + window.scrollX);
                            _contentY = _contentY + _originYDifference * instance.model.get('zoom'); //+ (event.clientY - instance.el.getBoundingClientRect().top + window.scrollY);
                        }
                        else {
                            
                            
                            
                            
                            
                            // origin must be 0, 0 for this algorithm
                            // current.left - (origin x / current image width) * (new image width - current image width)
                            var _contentWidth = instance.content.getBoundingClientRect().width;
                            var _contentHeight = instance.content.getBoundingClientRect().height;
                            var _initialContentWidth = instance.content.getBoundingClientRect().width / instance.model.get('zoom');
                            var _initialContentHeight = instance.content.getBoundingClientRect().height / instance.model.get('zoom');
                            var _originPercent = {
                                x: _zoomOriginScaled.x / _contentWidth,
                                y: _zoomOriginScaled.y / _contentHeight
                            };
                                
                            
                            
                            console.log('origin %: ', {
                                x: _originPercent.x,
                                y: _originPercent.y
                            });
                            console.log('size diff: ', { 
                                x: (_initialContentWidth * _newValue - _initialContentWidth),
                                y: (_initialContentHeight * _newValue - _initialContentHeight)
                            });
                            console.log('original size: ', { 
                                x: _initialContentWidth, 
                                y:  _initialContentHeight 
                            });
                            console.log('origin diff offset: ', { 
                                x: (_zoomOriginScaledDiff.x / (instance.model.get('zoom') / instance.model.get('zoomIncrement'))), 
                                y: (_zoomOriginScaledDiff.y / (instance.model.get('zoom') / instance.model.get('zoomIncrement'))) 
                            });
                            
                            _contentX = _originPercent.x * (_initialContentWidth * _newValue - _initialContentWidth) * -1 + (_zoomOriginScaledDiff.x / (instance.model.get('zoom') / instance.model.get('zoomIncrement')));
                            _contentY = _originPercent.y * (_initialContentHeight * _newValue - _initialContentHeight) * -1 + (_zoomOriginScaledDiff.y / (instance.model.get('zoom') / instance.model.get('zoomIncrement')));
                            
                            
                            
                            //var _contentX = Math.round(_zoomOriginScaledDiff.x * (_newValue - 1) ); // + _originXDifference; //+ (event.clientX - instance.el.getBoundingClientRect().left + window.scrollX);
                            //var _contentY = Math.round(_zoomOriginScaledDiff.y * (_newValue - 1) ); // + _originYDifference; //+ (event.clientY - instance.el.getBoundingClientRect().top + window.scrollY);
                        }

                        console.log('coords: ', _contentX, ',', _contentY);

                        instance.content.style.left = _contentX + 'px';
                        instance.content.style.top = _contentY + 'px';
                        
                        instance.model.set('zoom', _newValue);
                        
                        //instance.setZoomOrigin(event);
                        
                    }
                }
            };
            
            instance.setZoomOrigin = function (event) {
                
            };
            
            /**
            * Zooms content in or out.
            * @public
            */
            instance.zoom = function () {
                //instance.content.style.transformOrigin =  instance.model.get('zoomOrigin').x + 'px ' + instance.model.get('zoomOrigin').y + 'px';
                console.log('zoomed to: ', instance.model.get('zoom'));
                instance.content.style.transform = 'scale(' + instance.model.get('zoom') + ')';
                
            };
            
            Backbone.View.call(instance, options);
            
            return instance;
        };
        
 
        // App
        var app = Object.assign({}, Backbone.Events);
        
        app.initialize = function () {
            // Views
            var cameraView = CameraView({
                el: document.getElementById('camera'),
                template: _.template(document.getElementById('cameraTemplate').innerHTML),
                model: CameraModel({
                    zoom: 1,
                    zoomInCount: 3,
                    zoomOutCount: 3,
                    zoomInMultiplier: 2,
                    zoomOutMultiplier: 0.5,
                    zoomIncrement: 0.5
                }),
                height: 500,
                width: 1000
            }).render();
        };
        
        app.initialize();
    </script>
    
</body>
</html>