<!DOCTYPE html>
<html lang="en">
<head>
	<title>Backbone Camera View</title>
    <style>
        body {
            /*overflow: hidden;*/
        }
        
        .bcv-camera {
            border: 1px solid gray;
            height: 500px;
            overflow: hidden;
            position: relative;
            width: 1000px;
        }
        .bcv-camera > :first-child {
            position: absolute;
            transform-origin: 0 0;
            
            background-color: lightgray;
            top: 0px;
            left: 0px;
        }
    </style>
</head>
<body>
    <h1>Backbone Camera View</h1>
    
    <div id="camera" class="bcv-camera"></div>
    
    <script id="cameraTemplate" type="text/template">
        <div>
            <img src="images/FFL-Spritesheet-White-1827x1215.png" alt="Final Fantasy Legend Sprites" width="1827" height="1215" />
            <div style="position: absolute; top: 0; left: 0; width: 100px; height: 100px; border: 1px solid green;"></div>
            <div style="position: absolute; top: 0; left: 0; width: 200px; height: 200px; border: 1px solid green;"></div>
        </div>
        <div style="position: absolute; top: 0; left: 0; width: 100px; height: 100px; border: 1px solid blue;"></div>
        <div style="position: absolute; top: 0; left: 0; width: 200px; height: 200px; border: 1px solid red;"></div>
        
        <div style="position: absolute; top: 105px; left: 180px; width: 3px; height: 3px; background-color: red;"></div>
        <div style="position: absolute; top: 249px; left: 615px; width: 3px; height: 3px; background-color: red;"></div>
    </script>
    
    <script type="text/javascript" src="src/scripts/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="src/scripts/lodash.min.js"></script>
    <script type="text/javascript" src="src/scripts/backbone-min.js"></script>
    <script>
        'use strict';
        
        /**
        * Throttling using requestAnimationFrame.
        */
        var throttleToFrame = function (func) {
            var _this = null,
                _arguments = null,
                _isProcessing = false;

            return function () {
                _this = this;
                _arguments = arguments;
                
                if (!_isProcessing) {
                    _isProcessing = true;

                    window.requestAnimationFrame(function() {
                        func.apply(_this, _arguments);
                        _isProcessing = false;
                    });    
                }
            };
        };
        
        /**
        * Height and width resizing functionality used for object composition.
        * @constructs SizableView
        */
        var SizableView = function () {
            var instance = {};
            
            instance.setHeight = function (height) {
                if (_.isNumber(height)) {
                    this.$el.height(height);
                }
                else if (_.isElement(height)) {
                    this.$el.height(height.clientHeight);
                }
                else if (_.isFunction(height)) {
                    this.$el.height(height());
                }
            };
            
            instance.setWidth = function (width) {
                if (_.isNumber(width)) {
                    this.$el.width(width);
                }
                else if (_.isElement(width)) {
                    this.$el.width(width.clientWidth);
                }
                else if (_.isFunction(width)) {
                    this.$el.width(width());
                }
            };
            
            return instance;
        };
        
        var constants = {};
        constants.zoom = {
            IN: 1,
            OUT: 0
        };
        
        /**
        * A CameraView's model.
        * @constructs CameraModel
        */
        var CameraModel = function (options) {
            var instance = Object.create(Object.assign(
                Backbone.Model.prototype, {
                    defaults: {
                        /**
                        * The current zoom value.
                        * @property {Number}
                        */
                        zoom: 1,
                        /**
                        * The base zoom increment.
                        * @property {Number}
                        */
                        increment: 0.02,
                        /**
                        * The minimum allowed zoom value.
                        * @property {Number}
                        */
                        zoomMin: 0.1,
                        /**
                        * The maximum allowed zoom value.
                        * @property {Number}
                        */
                        zoomMax: 4
                    }
                }
            ));
            
            instance.initialize = function () {
                
            };
            
            Backbone.Model.call(instance, options);
            
            return instance;
        };
        
        /**
        * A camera to pan and zoom content.
        * @constructs CameraView
        */
        var CameraView = function (options) {
            var instance = Object.create(Object.assign(
                Backbone.View.prototype, SizableView()
            ));
            
            Object.assign(instance, options);
            
            instance.initialize = function () {
                instance.listenTo(instance.model, 'change:zoom', instance.zoom);
                
                return instance;
            };
            
            instance.render = function () {
                instance.el.innerHTML = instance.template();
                instance.content = instance.el.querySelector(':first-child');
                instance.content.setAttribute('draggable', false);
                instance.update();
                
                return instance;
            };
            
            instance.update = function () {
                instance.setWidth(instance.width);
                instance.setHeight(instance.height);
                
                return instance;
            };
            
            instance.events = function () {
                return {
                    'click'      : 'onClick',
                    'mouseenter' : 'onMouseEnter',
                    'mousedown'  : 'onMouseDown',
                    'mouseleave' : 'onMouseLeave',
                    'mousemove'  : 'onMouseMove',
                    'mouseup'    : 'onMouseUp',
                    'wheel'      : throttleToFrame(instance.onWheel)
                };
            };
            
            instance.onClick = function ($event) {
                var event = $event.originalEvent;
                console.log({ 
                    x: event.clientX - instance.content.getBoundingClientRect().left + window.scrollX,
                    y: event.clientY - instance.content.getBoundingClientRect().top + window.scrollX
                });
            };
            
            instance.stop = function () {
                instance.isActive = false;
            };
            
            instance.onMouseDown = function ($event) {
                // TODO: Remove console.log() when development is complete.
                //console.log($event.originalEvent);
                
                //console.log(instance.el.getBoundingClientRect());
                //console.log('top: ', instance.el.getBoundingClientRect().top + window.scrollY);
                instance.moveStartX = event.clientX;
                instance.moveStartY = event.clientY;
                instance.contentStartX = instance.content.getBoundingClientRect().left + window.scrollX - instance.el.getBoundingClientRect().left + window.scrollX;
                instance.contentStartY = instance.content.getBoundingClientRect().top + window.scrollY - instance.el.getBoundingClientRect().top + window.scrollY;
                
                instance.isActive = true;
                
                //console.log('scrollTop: ', instance.el.scrollTop);
                //console.log('scrollLeft: ', instance.el.scrollLeft);
                //console.log('scrollWidth: ', instance.el.scrollWidth);
                //console.log('scrollHeight: ', instance.el.scrollHeight);
                //console.log('eventX: ', event.clientX);
                //console.log('eventY: ', event.clientY);
                //console.log('elX: ', instance.el.getBoundingClientRect());
                //console.log('elY: ', instance.el.getBoundingClientRect());
                //console.log('mouse startX: ', instance.startX);
                //console.log('mouse startY: ', instance.startY);
                //console.log('content startX: ', instance.content.getBoundingClientRect().left - instance.el.getBoundingClientRect().left);
                //console.log('content startY: ', instance.content.getBoundingClientRect().top - instance.el.getBoundingClientRect().top);
            };
            
            instance.onMouseEnter = function ($event) {
                $('body').css('overflow', 'hidden');
            };
            
            instance.onMouseLeave = function ($event) {
                instance.stop();
                // TODO: Instead of reverting to 'auto' remove the inline style rule to let any applied stylesheet rule kick in. 
                $('body').css('overflow', 'auto');
            };
            
            instance.onMouseMove = function ($event) {
                // TODO: Refactor. Add drag-ability of content when zoomed in/out.
                if (instance.isActive) {
                    console.log('move');
                    // Handle vertical bounds
                    if (instance.contentStartX + event.clientX - instance.moveStartX < 0) {
                        instance.content.style.left = (instance.contentStartX + event.clientX - instance.moveStartX) + 'px';
                    }
                    if (instance.contentStartX + event.clientX - instance.moveStartX >= 0) {
                        instance.moveStartX = event.clientX;
                        instance.contentStartX = 0;
                        instance.content.style.left = 0 + 'px';
                    }
                    if (instance.contentStartX + event.clientX - instance.moveStartX <= instance.el.clientWidth - instance.content.getBoundingClientRect().width) {
                        instance.moveStartX = event.clientX;
                        instance.contentStartX = instance.el.clientWidth - instance.content.getBoundingClientRect().width;
                        instance.content.style.left = instance.el.clientWidth - instance.content.getBoundingClientRect().width + 'px';
                    }
                    
                    // Handle horizontal bounds
                    if (instance.contentStartY + event.clientY - instance.moveStartY < 0) {
                        instance.content.style.top = (instance.contentStartY + event.clientY - instance.moveStartY) + 'px';
                    }
                    if (instance.contentStartY + event.clientY - instance.moveStartY >= 0) {
                        instance.moveStartY = event.clientY;
                        instance.contentStartY = 0;
                        instance.content.style.top = 0 + 'px';
                    }
                    if (instance.contentStartY + event.clientY - instance.moveStartY <= instance.el.clientHeight - instance.content.getBoundingClientRect().height) {
                        instance.moveStartY = event.clientY;
                        instance.contentStartY = instance.el.clientHeight - instance.content.getBoundingClientRect().height;
                        instance.content.style.top = instance.el.clientHeight - instance.content.getBoundingClientRect().height + 'px';
                    }
                }
            };
            
            instance.onMouseUp = function ($event) {
                instance.stop();
            };
            
            /**
            * Handles the wheel input.
            * @public
            * @param {$event} A jQuery event object.
            */
            instance.onWheel = function ($event) {
                var event = $event.originalEvent;
                
                event.preventDefault();
                instance.wheelZoom(event);
            };
            
            /**
            * Determines whether to zoom in or out based on the wheel input.
            * @public
            * @param {event} A mouse event object.
            */
            instance.wheelZoom = function (event) {
                if (event.deltaY) {
                    var _precision = 2;
                    var _direction = null;
                    var _delta = 0;
                    var _zoom = instance.model.get('zoom');
                    var _newZoom = _zoom;
                    var _increment = instance.model.get('increment');
                    var _min = instance.model.get('zoomMin');
                    var _max = instance.model.get('zoomMax');
                    var _originX = (event.clientX - instance.content.getBoundingClientRect().left) / _zoom;
                    var _originY = (event.clientY - instance.content.getBoundingClientRect().top) / _zoom;
                    var _contentX = parseFloat(window.getComputedStyle(instance.content).getPropertyValue('left'));
                    var _contentY = parseFloat(window.getComputedStyle(instance.content).getPropertyValue('top'));
                    
                    if (event.deltaY) {
                        _direction = event.deltaY > 0 ? constants.zoom.OUT : constants.zoom.IN;
                    } 
                    else if (event.wheelDelta) {
                        _direction = event.deltaY > 0 ? constants.zoom.OUT : constants.zoom.IN;
                    } 
                    else if (event.detail) {
                        _direction = event.detail > 0 ? constants.zoom.OUT : constants.zoom.IN;
                    }
                    
                    // TODO: Use of '_delta' and 'increment' are sloppy and confusing. Clean up.
                    // Limit max zoom speed
                    _delta = Math.min(Math.abs(event.deltaY), 10) * (_direction === constants.zoom.IN ? 1 : -1);
                    console.log(_delta);
                    
                    // Calculate progressive zoom increment
                    if (_zoom <= 2) {
                        _increment = _.round(_increment * _zoom, _precision);
                    }
                    else {
                        _increment = _.round(_increment + (Math.round(_zoom) / 100), _precision);
                    }
                    
                    console.log('zIncrement: ', _increment);
                    
                    // Determine zoom
                    _newZoom = _.round(_zoom + _increment * _delta, _precision);
                
                    if (_newZoom < _min) {
                        _newZoom = _min;
                    }
                    else if (_newZoom > _max) {
                        _newZoom = _max;
                    }
                    
                    // Prevent zooming beyond limits
                    _delta = _newZoom - _zoom;

                    if (_zoom !== _newZoom) {
                        _contentX = _.round(_contentX + -1 * _originX * _delta, _precision);
                        _contentY = _.round(_contentY + -1 * _originY * _delta, _precision);

                        instance.content.style.left = _contentX + 'px';
                        instance.content.style.top = _contentY + 'px';
                        
                        instance.model.set('zoom', _newZoom);
                    }
                }
            };
            
            /**
            * Zooms content in or out.
            * @public
            */
            instance.zoom = function () {
                // TODO: Remove when development is complete
                console.log('zoomed to: ', instance.model.get('zoom'));
                instance.content.style.transform = 'scale(' + instance.model.get('zoom') + ')';
            };
            
            Backbone.View.call(instance, options);
            
            return instance;
        };
        
 
        // App
        var app = Object.assign({}, Backbone.Events);
        
        app.initialize = function () {
            // Views
            var cameraView = CameraView({
                el: document.getElementById('camera'),
                template: _.template(document.getElementById('cameraTemplate').innerHTML),
                model: CameraModel({
                    zoom: 1,
                    increment: 0.02,
                    zoomMin: 0.25,
                    zoomMax: 6
                })
            }).render();
            
            window.cameraView = cameraView;
        };
        
        app.initialize();
    </script>
    
</body>
</html>